!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("HMap",[],t):"object"==typeof exports?exports.HMap=t():e.HMap=t()}(this,function(){return function(e){function t(r){if(a[r])return a[r].exports;var i=a[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,t),i.l=!0,i.exports}var a={};return t.m=e,t.c=a,t.i=function(e){return e},t.d=function(e,a,r){t.o(e,a)||Object.defineProperty(e,a,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var a=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(a,"a",a),a},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=0)}([function(module,exports,__webpack_require__){"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,a=Array(e.length);t<e.length;t++)a[t]=e[t];return a}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var a=0;a<t.length;a++){var r=t[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,a,r){return a&&e(t.prototype,a),r&&e(t,r),t}}(),HDMap=function(){function HDMap(){_classCallCheck(this,HDMap),this.mapTools={addPoint:!1,ljQuery:!1,iQuery:!1,drawPlot:!1,addTextArea:!1,toolsType:{addPoint:"addPoint",ljQuery:"ljQuery",iQuery:"iQuery",drawPlot:"drawPlot",addTextArea:"addTextArea"}},this.addPointHandlerClick=null,this.plotDraw=null,this.plotEdit=null,this._lastDrawInteractionGeometry=null,this.wgs84Sphere=new ol.Sphere(6378137),window.ObservableObj=new ol.Object,this.currentMapLines=[],this.currentMapPoints=[],this.lineLayers=new Set,this.pointLayers=new Set,this.polygonLayers=new Set,this.circleSerachFeat=null,this.popupOverlay=null}return _createClass(HDMap,[{key:"getMapParams",value:function(e,t){var a=this;new Promise(function(r,i){$.ajax({url:t.layerUrl+"?f=pjson",type:"GET",dataType:"jsonp",jsonp:"callback",success:function(o){if(o){var n={projection:o.spatialReference.wkid,fullExtent:[o.fullExtent.xmin,o.fullExtent.ymin,o.fullExtent.xmax,o.fullExtent.ymax],origin:[o.tileInfo.origin.x,o.tileInfo.origin.y],tileSize:o.tileInfo.cols,lods:o.tileInfo.lods,tileUrl:t.layerUrl,center:t.center,zoom:t.zoom,config:t.config,layerName:t.layerName};a.initMap(e,n),r(n)}else i(o)}})})}},{key:"initMap",value:function(e,t){var a=t||{},r=this;this.projection=ol.proj.get("EPSG:"+a.projection),this.fullExtent=a.fullExtent,this.projection.setExtent(this.fullExtent),this.origin=a.origin,this.tileSize=a.tileSize,this.resolutions=[];for(var i=a.lods.length,o=0;o<i;o++)this.resolutions.push(a.lods[o].resolution);var n=ol.extent.getWidth(this.projection.getExtent())/256;this._resolutions=new Array(19),this.matrixIds=new Array(19);for(var l=0;l<19;++l)this._resolutions[l]=n/Math.pow(2,l),this.matrixIds[l]=l;var s=a.tileUrl,c=new ol.tilegrid.TileGrid({tileSize:r.tileSize,origin:r.origin,extent:r.fullExtent,resolutions:r.resolutions}),y=s+"/tile/{z}/{y}/{x}",u=new ol.source.XYZ({wrapX:!1,tileGrid:c,projection:r.projection,tileUrlFunction:function(e){var t=y.replace("{z}",e[0].toString()).replace("{x}",e[1].toString()).replace("{y}",(-e[2]-1).toString());return t}}),m=new ol.layer.Tile({isBaseLayer:!0,isCurrentBaseLayer:!0,layerName:a.layerName,source:u});this.map=new ol.Map({target:e,loadTilesWhileAnimating:!0,interactions:ol.interaction.defaults({doubleClickZoom:!0,keyboard:!1}).extend([new app.Drag]),controls:[new ol.control.ScaleLine({target:"hdscalebar"}),new ol.control.Loading],layers:[m],view:new ol.View({center:ol.proj.fromLonLat(a.center,r.projection),zoom:a.zoom,projection:r.projection,extent:r.fullExtent,maxResolution:r._resolutions[4],minResolution:r._resolutions[18]})}),this.addVectorLabel(),this.map.getView().setZoom(this.map.getView().getZoom()-2),this.addEvent(),this.addImageBaseLayer(),this.addDemBaseLayer()}},{key:"addVectorLabel",value:function(){var e=this.getLayerConfigByName("vectorLabel");if(void 0===e||void 0===e.layerName)return console.info("未配置此地图"),null;var t=e.layerUrl,a=new ol.tilegrid.TileGrid({tileSize:this.tileSize,origin:this.origin,extent:this.fullExtent,resolutions:this.resolutions}),r=t+"/tile/{z}/{y}/{x}",i=new ol.source.XYZ({wrapX:!1,tileGrid:a,projection:this.projection,tileUrlFunction:function(e){var t=r.replace("{z}",e[0].toString()).replace("{x}",e[1].toString()).replace("{y}",(-e[2]-1).toString());return t}}),o=new ol.layer.Tile({isBaseLayer:!0,isCurrentBaseLayer:!0,layerName:e.layerName,source:i});this.map.getLayers().insertAt(1,o)}},{key:"getLayerConfigByName",value:function(e){var t=config.mapConfig.baseLayers;config.mapConfig.thematicLayers&&config.mapConfig.thematicLayers.length>0&&(t=t.concat(config.mapConfig.thematicLayers));var a=t.filter(function(t){return e===t.layerName});return a[0]}},{key:"initTDTLayer",value:function(e){for(var t=ol.proj.get("EPSG:4326"),a=ol.extent.getWidth(t.getExtent())/256,r=new Array(19),i=new Array(19),o=0;o<19;++o)r[o]=a/Math.pow(2,o),i[o]=o;var n=new ol.layer.Tile({isBaseLayer:!0,isCurrentBaseLayer:!1,layerName:e.layerName,opacity:1,visible:!1,source:new ol.source.WMTS({url:e.layerUrl,layer:e.layer,matrixSet:"c",format:"tiles",projection:t,tileGrid:new ol.tilegrid.WMTS({origin:ol.extent.getTopLeft(this.projection.getExtent()),resolutions:r,matrixIds:i}),style:"default",wrapX:!1})});return n}},{key:"addImageBaseLayer",value:function(){var e=this.getLayerConfigByName("earth");if(void 0===e||void 0===e.layerName)return console.info("未配置此地图"),null;var t=this.initTDTLayer(e),a={layerName:"mapMake",layer:"cia",layerUrl:"http://t0.tianditu.cn/cia_c/wmts"},r=this.initTDTLayer(a);this.map.getLayers().insertAt(0,t),this.map.getLayers().insertAt(1,r)}},{key:"addDemBaseLayer",value:function(){var e=this.getLayerConfigByName("panorama");if(void 0===e||void 0===e.layerName)return console.info("未配置此地图"),null;var t=this.initTDTLayer(e);this.map.getLayers().insertAt(0,t)}},{key:"addTDTerBaseLayer",value:function(){var e=this.getLayerConfigByName("天地图");if(void 0===e||void 0===e.layerName)return console.info("未配置此地图"),null;var t=this.initTDTLayer(e);this.map.getLayers().insertAt(0,t)}},{key:"loadArcMapService",value:function(e){if(this.map){var t=this.getLayerConfigByName(e);if(t){var a=t.params,r=t.serviceUrl,i=new ol.source.TileArcGISRest({url:r,params:a,wrapX:!1}),o=new ol.layer.Tile({layerName:e,source:i,wrapX:!1});this.map.addLayer(o)}else console.log("请配置相关图层！")}}},{key:"changeBaseLayer",value:function(e){if(this.map){var t=this.getLayerByName("mapMake"),a=this.getLayerByName("vectorLabel"),r=this.map.getLayers().getArray(),i=r.filter(function(t){return t.get("isBaseLayer")&&(t.set("isCurrentBaseLayer",!1),t.setVisible(!1)),t.get("layerName")===e})[0];if(i)switch(i.setVisible(!0),i.set("isCurrentBaseLayer",!0),e){case"vector":t.setVisible(!1),a.setVisible(!0);break;case"earth":t.setVisible(!0);break;case"panorama":t.setVisible(!0);break;case"天地图":t.setVisible(!0)}}}},{key:"addEvent",value:function(){var e=this;this.map.on("click",function(t){if(window.ObservableObj.dispatchEvent("clickEvent"),e.mapTools.iQuery)return void(null!=e.queryparams&&null!=e.queryparams.drawend&&(e.queryparams.drawend(t),e.mapTools.iQuery=!1));if(e.plotDraw&&!e.plotDraw.isDrawing()){var a=e.map.forEachFeatureAtPixel(t.pixel,function(e){return e});a&&a.getGeometry().isPlot?(e.plotEdit.activate(a),window.ObservableObj.set("plotFeature",a),window.ObservableObj.dispatchEvent("choosePlot")):e.plotEdit.deactivate()}},this),this.map.on("singleclick",function(t){var a=e.map.forEachFeatureAtPixel(t.pixel,function(e){return e});console.log(t.coordinate),a&&(e.plotDraw||a.getGeometry().isPlot||(window.ObservableObj.set("clickFeat",{feature:a,coordinate:t.coordinate}),window.ObservableObj.dispatchEvent("clickFeatEvent")))},this),this.moveInteraction=new ol.interaction.Select({condition:ol.events.condition.pointerMove,style:function e(t,a){var r=[],e=new ol.style.Style({stroke:new ol.style.Stroke({color:"#D97363",width:10})});return r.push(e),r},layers:function(e){return e.get("selectable")},filter:function(e,t){return!e.get("features")||e.get("features").length<=1}}),this.map.addInteraction(this.moveInteraction),this.moveInteraction.on("select",function(t){var a=t.selected;if(0==a.length){var r=t.deselected;if(r.length>0){var i=r[0],o=i.get("belongLayer");if(o&&o.getSource()instanceof ol.source.Cluster)i.setStyle(o.getStyle());else if(i.get("features")){var n=i.get("features");if(n[0]){var l=n[0].get("belongLayer");n[0].get("belongLayer")&&i.setStyle(l.getStyle())}}else{var s=i.get("normalStyle");s&&i.setStyle(s)}window.currentFeat=null,window.ObservableObj.dispatchEvent({type:"mouseOnFeatureEvent",originEvent:t,value:i})}}else{var c=a[0],y=e.moveInteraction.get("lastSelectFeature");y&&y.get("normalStyle")&&y.setStyle(y.get("normalStyle")),e.moveInteraction.set("lastSelectFeature",c);var u=e.moveInteraction.getLayer(c),m=c.get("selectStyle")||u.get("selectedStyle");m&&c.setStyle(m),c.get("features")&&(c=c.get("features")[0]),c.set("belongLayer",u),window.currentFeat=null,window.ObservableObj.dispatchEvent({type:"mouseOnFeatureEvent",originEvent:t,value:c})}})}},{key:"getLayerByName",value:function(e){var t=null;if(this.map){var a=this.map.getLayers();a.forEach(function(a){var r=a.get("layerName");r===e&&(t=a)},this)}return t}},{key:"getTempVectorLayer",value:function(e,t){if(this.map){var a=this.getLayerByName(e);if(a instanceof ol.layer.Vector||(a=null),!a&&t&&t.create){var r=new ol.source.Vector({wrapX:!1});a=new ol.layer.Vector({layerName:e,params:t,source:r,style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(67, 110, 238, 0.4)"}),stroke:new ol.style.Stroke({color:"#4781d9",width:2}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:"#ffcc33"})})})})}return this.map&&a&&(this.getLayerByName(e)||(t&&t.hasOwnProperty("selectable")&&a.set("selectable",t.selectable),this.map.addLayer(a))),a}}},{key:"activeTool",value:function activeTool(toolType,params){var _this2=this;if(this.map&&(this.deactiveAll(),this.mapTools.hasOwnProperty(toolType)))switch(this.mapTools[toolType]=!0,toolType){case this.mapTools.toolsType.addPoint:this.addPointHandlerClick=this.map.once("singleclick",function(e){_this2.addPoint({geometry:e.coordinate},params)});break;case this.mapTools.toolsType.ljQuery:this.queryparams=params,ol.Observable.unByKey(this.addPointHandlerClick),this.addPointHandlerClick=this.map.on("singleclick",function(e){_this2.mapTools.ljQuery&&_this2.addPoint({geometry:e.coordinate},params)});break;case this.mapTools.toolsType.drawPlot:this.plotEdit||(this.plotDraw=new P.PlotDraw(this.map),this.plotEdit=new P.PlotEdit(this.map),this.plotDraw.on(P.Event.PlotDrawEvent.DRAW_END,function(e){var t=e.feature;_this2.setLastDrawInteractionGeometry(t.getGeometry().clone()),_this2.plotEdit.activate(t),_this2.getTempVectorLayer(params.layerName,{create:!0}).getSource().addFeature(t),window.ObservableObj.set("PlotFeature",t),window.ObservableObj.dispatchEvent("PlotFeatureEvt")},!1,this)),this.plotEdit.deactivate(),this.plotDraw.activate(eval(params.plotType),params);break;case this.mapTools.toolsType.addTextArea:this.map.once("singleclick",function(e){window.ObservableObj.set("event",e),window.ObservableObj.dispatchEvent("singleClickEvent")});break;case this.mapTools.toolsType.iQuery:this.queryparams=params}}},{key:"getLastDrawInteractionGeometry",value:function(){if(this.map)return this._lastDrawInteractionGeometry}},{key:"setLastDrawInteractionGeometry",value:function(e){this.map&&(e instanceof ol.geom.Geometry?this._lastDrawInteractionGeometry=e:console.error(e,"不是几何对象"))}},{key:"deactiveAll",value:function(){if(this.map){for(var e in this.mapTools)"boolean"==typeof this.mapTools[e]&&(this.mapTools[e]=!1);this.removeDrawInteraion()}}},{key:"removeDrawInteraion",value:function(){this.map&&(this.draw&&this.map.removeInteraction(this.draw),delete this.draw,this.draw=null)}},{key:"addPoint",value:function(e,t){if(this.map){var a=null,r=null;t||(t={}),a=e instanceof ol.geom.Geometry?e:$.isArray(e.geometry)?new ol.geom.Point(e.geometry):(new ol.format.WKT).readGeometry(e.geometry);var i=new ol.Feature({geometry:a,params:t}),o=t.featureType,n=null;n=e.attributes&&e.attributes.imgSrc||e.imgSrc?e.imgSrc?e.imgSrc:e.attributes.imgSrc:t.imgSrc?t.imgSrc:o?config.markConfig.getMarkConfigByType(o).imgURL:config.markConfig.getDefaultMrakConfig().imgURL;var l=new ol.style.Style({image:new ol.style.Icon({anchor:[.5,25],anchorXUnits:"fraction",anchorYUnits:"pixels",opacity:.75,src:n})});if(i.setStyle(l),(t.id||e.attributes&&e.attributes.id)&&(r=t.id?t.id:e.attributes.id,i.setId(r)),t.layerName){var s=this.getTempVectorLayer(t.layerName,{create:!0});s.getSource().addFeature(i),this.pointLayers.add(t.layerName)}else this.tempVectorLayer.getSource().addFeature(i);return t.drawend&&"function"==typeof t.drawend&&t.drawend({feature:i}),this.addPointHandlerClick&&ol.Observable.unByKey(this.addPointHandlerClick),this.deactiveAll(),this.OrderLayerZindex(),this.MovePointToView(a.getCoordinates()),i}}},{key:"addTypePoints",value:function(e,t,a){if(this.map){if(a||(a={}),a.isClear&&this.clearGraphics(),!e||0==e.length)return!1;for(var r=new ol.geom.MultiPoint([]),i=[],o=0;o<e.length;o++){var n=e[o],l=null,s=void 0,c=void 0;if(n&&n.geometry&&(!$.isArray(n.geometry)||0!=n.geometry[0]&&0!=n.geometry[1])){l=n instanceof ol.geom.Geometry?n:$.isArray(n.geometry)?new ol.geom.Point(n.geometry):(new ol.format.WKT).readGeometry(n.geometry);var y=new ol.Feature({geometry:l});if(r.appendPoint(l),a&&(y.set("params",a),a.layerName&&y.set("layerName",a.layerName)),n.attributes||(n.attributes={}),n.attributes.ID||n.attributes.id){y.setId(n.attributes.ID?n.attributes.ID:n.attributes.id),y.setProperties(n.attributes),n.attributes.imgSrc?(c=n.attributes.imgSrc,s=n.attributes.imgSrcHover?n.attributes.imgSrcHover:n.attributes.imgSrc):a.featureType?(c=config.markConfig.getMarkConfigByType(a.featureType).imgURL,s=config.markConfig.getMarkConfigByType(a.featureType).hover,s||(s=c)):(c=config.markConfig.getDefaultMrakConfig().imgURL,s=config.markConfig.getDefaultMrakConfig().imgURL);var u=void 0,m=void 0;if(a.orderBy?(u=new ol.style.Style({image:new ol.style.Icon({anchor:[.5,.5],anchorXUnits:"fraction",anchorYUnits:"fraction",src:c}),text:new ol.style.Text({text:o+1+"",offsetX:.5,offsetY:-18,fill:new ol.style.Fill({color:"#fff"})})}),m=new ol.style.Style({image:new ol.style.Icon({anchor:[.5,.5],anchorXUnits:"fraction",anchorYUnits:"fraction",src:s}),text:new ol.style.Text({text:o+1+"",offsetX:.5,offsetY:-18,fill:new ol.style.Fill({color:"#fff"})})})):(u=new ol.style.Style({image:new ol.style.Icon({anchor:[.5,.5],anchorXUnits:"fraction",anchorYUnits:"fraction",src:s})}),m=new ol.style.Style({image:new ol.style.Icon({anchor:[.5,.5],anchorXUnits:"fraction",anchorYUnits:"fraction",src:c})})),a.showStyle&&(y.set("normalStyle",m),y.set("selectStyle",u)),null!=m&&y.setStyle(m),t&&"overlay"==t)this.addTypeOverlay(y,n.attributes,a,o);else if(a.layerName){var h=this.getTempVectorLayer(a.layerName,{create:!0});h.getSource().addFeature(y),this.pointLayers.add(a.layerName)}else this.tempVectorLayer.getSource().addFeature(y)}else console.info("传入的数据缺少id")}}return a.disZoomToExtent||this._getExtent(r),this.OrderLayerZindex(),i}}},{key:"addTypeOverlay",value:function(e,t,a,r){try{if(!this.map)return;var i=document.createElement("div");i.className="overlay-point iconfont";var o="#EB4F38",n="31px",l=1,s="",c=null,y=null,u=[],m=null,h=0;if(t.icon?y=t.icon:a.icon&&(y=a.icon),y&&(y.className&&$(i).addClass(y.className),y.color&&(o=y.color),y.fontSize&&(n=y.fontSize),y.opacity&&(l=y.opacity),y.element&&(s=document.createElement("div"),s.className=y.element.className?y.element.className:"maked-point",s.style.top=y.element.top?y.element.top:"-100%",s.style.left=y.element.left?y.element.left:"100%",s.style.fontSize=y.element.fontSize?y.element.fontSize:"16px",s.style.borderColor=y.element.borderColor?y.element.borderColor:"#2A2A2A",s.style.borderWidth=y.element.borderWidth?y.element.borderWidth:"1px",s.innerHTML=y.element.text?y.element.text:"")),a.orderBy?(h=r+1,m=document.createElement("span")):a.orderByNum&&t.number&&(h=Number(t.number)+1,m=document.createElement("span")),m&&""==s&&(m.innerHTML=h,i.appendChild(m)),""!==s&&i.appendChild(s),i.style.color=o,i.style.fontSize=n,i.style.opacity=l,i.selectColor="#1b9de8",i.normalColor=o,i.onmousedown=function(t){2==t.button?(window.ObservableObj.set("rightMenuFeature",e),window.ObservableObj.dispatchEvent("rightMenuEvt")):0==t.button&&(window.ObservableObj.set("overlay",e),window.ObservableObj.dispatchEvent("overlayEvent"))},e){c=e.getId();var p=this.map.getOverlayById(c);if(p)p.setElement(i);else{u=e.getGeometry().getCoordinates();var f=new ol.Overlay({element:i,positioning:"center-center",id:c,offset:[0,-10],stopEvent:!0});f.set("feature",e),f.setPosition(u),a&&(f.set("params",a),a.layerName&&f.set("layerName",a.layerName)),this.map.addOverlay(f)}}}catch(e){}}},{key:"addPolyline",value:function(e,t){if(this.map){var a=[];e instanceof Array?a=e:a.push(e);var r=null,i=null,o=null,n=null;r=t.style?t.style:{width:4,color:"#0000EE"},i=t.selectStyle?t.selectStyle:{width:6,color:"#FF0000"},o=new ol.style.Style({stroke:new ol.style.Stroke(r)}),n=new ol.style.Style({stroke:new ol.style.Stroke(i)});for(var l,s=0;s<a.length;s++){var c=a[s];if(c.geometry.hasOwnProperty("paths")){var y={type:"Feature",geometry:{type:"MultiLineString",coordinates:c.geometry.paths}};this.currentMapLines=this.currentMapLines.concat(c.geometry.paths),l=(new ol.format.GeoJSON).readFeature(y)}else{l=new ol.Feature({geometry:(new ol.format.WKT).readGeometry(c.geometry)});var u=l.getGeometry().getExtent();this.currentMapLines.push([[u[0],u[1]],[u[2],u[3]]]),this.zoomToExtent(u,!1)}if(t.showStyle&&(l.set("normalStyle",o),l.set("selectStyle",n)),c.attributes||(c.attributes={},c.attributes.layerName=t.layerName),(c.attributes.ID||c.attributes.id)&&(l.setId(c.attributes.ID||c.attributes.id),l.set("layerName",t.layerName),l.setProperties(c.attributes)),null!=o&&l.setStyle(o),t.layerName){var m=this.getTempVectorLayer(t.layerName,{create:!0});m.getSource().addFeature(l),this.lineLayers.add(t.layerName)}else this.tempVectorLayer.getSource().addFeature(l);return this.OrderLayerZindex(),l}}}},{key:"addPolylines",value:function(e,t){var a=this;if(this.map&&(t.isclear&&this.clearGraphics(),null!=e&&e.length>0)){e.forEach(function(e){a.addPolyline(e,t)});var r=new ol.geom.MultiLineString(this.currentMapLines,null).getExtent();r=this.adjustExtent(r),this.zoomToExtent(r,!1)}}},{key:"createSreachCircle",value:function(e,t,a){if(this.map){a||(a=5e3);var r=new ol.style.Style({fill:new ol.style.Fill({color:"rgba(65,105,225, 0.5)"})}),i={radius:a,maxRadius:5e4,map:this.map,layerName:e,style:r};if(i.radius>i.maxRadius&&(i.radius=i.maxRadius),t=$.extend(i,t),this.circleSerachFeat)this.circleSerachFeat.setCenter(t.center),this.circleSerachFeat.setRadius(t.radius);else{this.circleSerachFeat=new ol.Observable.CustomCircle(t);var o=this.circleSerachFeat.getExtent();this.zoomToExtent(o)}return this.polygonLayers.add(e),this.OrderLayerZindex(),this.circleSerachFeat}}},{key:"showPopup",value:function(e,t){if(this.map){var a="";this.popupOverlay&&!e.notClear&&(this.map.removeOverlay(this.popupOverlay),this.popupOverlay=null),a=e.id?e.id+"overlay":"overlay"+Math.floor(1e3*Math.random())+Math.floor(1e3*Math.random()+1);var r={positioning:"center-center",id:a};t&&(r.offset=t),e=$.extend(e,r),this.popupOverlay=new ol.Overlay.Popup(e),this.map.addOverlay(this.popupOverlay),this.popupOverlay.show(e.coordinate,e.content),this.panIntoView_(this.popupOverlay,e.coordinate,null)}}},{key:"closePopup",value:function(e){if(this.map)return this.popupOverlay&&this.popupOverlay.getId()!==e&&(this.map.removeOverlay(this.popupOverlay),this.popupOverlay=null),!1}},{key:"closePopupById",value:function(e){if(this.map){var t=this.map.getOverlayById(e);return this.map.removeOverlay(t),t}}},{key:"panIntoView_",value:function(e,t,a){if(this.map){var r={width:e.getElement().clientWidth+20,height:e.getElement().clientHeight+20},i=this.map.getSize(),o=40,n=60,l=r.width-n,s=e.getOffset(),c=this.map.getPixelFromCoordinate(t),y=c[0]-n,u=i[0]-(c[0]+l),m=c[1]-r.height+s[1],h=i[1]-(c[1]+o)-s[1],p=this.map.getView().getCenter(),f=this.map.getPixelFromCoordinate(p),d=f.slice();if(u<0?d[0]-=u:y<0&&(d[0]+=y),m<0?d[1]+=m:h<0&&(d[1]-=h),!a){a=1e3;var g=+new Date,v=ol.animation.pan({duration:a,source:this.map.getView().getCenter(),start:g});ol.animation.bounce({duration:a,resolution:this.map.getView().getResolution(),start:g});this.map.beforeRender(v)}return d[0]===f[0]&&d[1]===f[1]||this.map.getView().setCenter(this.map.getCoordinateFromPixel(d)),this.map.getView().getCenter()}}},{key:"getFeatureById",value:function(e,t){if(this.map){var a=null;if(t){var r=this.getLayerByName(t);r&&r instanceof ol.layer.Vector&&(a=r.getSource().getFeatureById(e))}if(!a){var i=this.map.getLayers();i.forEach(function(t){var r=t.getSource();r&&r.getFeatureById&&(a=r.getFeatureById(e))})}return a}}},{key:"highlightedOverlayById",value:function(e){if(this.map&&e&&""!==e){var t=this.map.getOverlayById(e);if(t&&t instanceof ol.Overlay){var a=t.getElement();return a.style.color=a.selectColor,$(a).children("div").css("borderColor",a.selectColor),$(a).addClass("marker-raise"),t}}}},{key:"highLightFeatureByID",value:function(e,t){if(this.map&&e&&"''"!==e.trim()){var a=this.getFeatureById(e,t);if(a&&a instanceof ol.Feature){var r=a.get("selectStyle");r&&r instanceof ol.style.Style&&a.setStyle(r)}return a}}},{key:"unHighLightFeatureByID",value:function(e,t){if(this.map&&e&&"''"!==e.trim()){var a=this.getFeatureById(e,t);if(a&&a instanceof ol.Feature){var r=a.get("normalStyle");r&&r instanceof ol.style.Style&&a.setStyle(r)}return a}}},{key:"unHighlightedOverlayById",value:function(e){if(this.map&&e&&""!==e){var t=this.map.getOverlayById(e);if(t&&t instanceof ol.Overlay){var a=t.getElement();return a.style.color=a.normalColor,$(a).children("div").css("borderColor",a.normalColor),$(t.getElement()).removeClass("marker-raise"),t}}}},{key:"adjustExtent",value:function(e){if(this.map){var t=ol.extent.getWidth(e),a=(ol.extent.getHeight(e),.2);if(t<.05){var r=ol.extent.getBottomLeft(e),i=ol.extent.getTopRight(e);r[0]-a,r[1]-a,i[0]+a,i[1]+a;e=ol.extent.buffer(e,a)}return e}}},{key:"_getExtent",value:function(e){if(this.map){var t=[];if(e.getPoints().length>0){t=e.getExtent();for(var a=!0,r=0;r<4;r++)if(t[r]==1/0||NaN==t[r]){a=!1;break}a&&this.zoomToExtent(t,!0)}return t}}},{key:"zoomToExtent",value:function(e,t,a){if(this.map){var r=this.map.getView(),i=this.map.getSize(),o=ol.extent.getCenter(e);if(t){if(!a){a=100;var n=ol.animation.pan({duration:a,source:r.getCenter()}),l=ol.animation.bounce({duration:a,resolution:r.getResolution()});this.map.beforeRender(n,l),r.setCenter(o),r.fit(e,i,{padding:[200,350,200,350]})}}else r.fit(e,i,{padding:[350,200,200,350]}),r.setCenter(o)}}},{key:"zoomByLineFeature",value:function(e){if(this.map){var t=null;if(e.geometry.hasOwnProperty("paths")){var a={type:"Feature",geometry:{type:"LineString",coordinates:e.geometry.paths[0]}};t=(new ol.format.GeoJSON).readFeature(a)}else t=new ol.Feature({geometry:(new ol.format.WKT).readGeometry(e.geometry)});if(null!=t){var r=t.getGeometry().getExtent();this.zoomToExtent(r,!1)}}}},{key:"OrderLayerZindex",value:function(){var e=this;this.map&&!function(){var t=5,a=e.map.getLayers();a.forEach(function(a){var r=a.get("layerName");[].concat(_toConsumableArray(e.polygonLayers)).indexOf(r)>=0&&a.setZIndex(t++)},e),a.forEach(function(a){var r=a.get("layerName");[].concat(_toConsumableArray(e.lineLayers)).indexOf(r)>=0&&a.setZIndex(t++)},e),a.forEach(function(a){var r=a.get("layerName");[].concat(_toConsumableArray(e.pointLayers)).indexOf(r)>=0&&a.setZIndex(t++)},e)}()}},{key:"getMapCurrentExtent",value:function(){if(this.map)return this.map.getView().calculateExtent(this.map.getSize())}},{key:"MovePointToView",value:function(e){if(this.map){var t=this.getMapCurrentExtent();ol.extent.containsXY(t,e[0],e[1])||this.map.getView().setCenter([e[0],e[1]])}}},{key:"setOverLayOpacityById",value:function(e){if(this.map&&e){var t=this.map.getOverlayById(e);if(t&&t instanceof ol.Overlay){var a="0"===t.getElement().style.opacity?1:0;t.getElement().style.opacity=a}}}},{key:"removeOverlayById",value:function(e){if(this.map&&e){var t=this.map.getOverlayById(e);return t&&t instanceof ol.Overlay&&this.map.removeOverlay(t),t}}},{key:"makeOverLayById",value:function(e,t){if(this.map&&e){var a=this.map.getOverlayById(e);a&&a instanceof ol.Overlay&&a.set("layerName",t)}}},{key:"clearGraphics",value:function(){this.map&&(this.removeDrawInteraion(),this.deactiveAll(),this.map.getOverlays().clear(),this._lastDrawInteractionGeometry=null,this.clearTempLayers(),this.removeAllTileLayer())}},{key:"clearTempLayers",value:function(){if(this.map){var e=this.map.getLayers();e&&e.forEach(function(e){e instanceof ol.layer.Vector&&e.getSource()&&e.getSource().clear&&e.getSource().clear()},this)}}},{key:"removeAllTileLayer",value:function(){var e=this;if(this.map){var t=this.map.getLayers();t.forEach(function(t){t.get("title")&&t.get("isImageType")&&e.map.removeLayer(t)},this)}}},{key:"removeFeatureByLayerName",value:function(e){if(this.map){this.plotEdit&&this.plotEdit.activePlot&&this.plotEdit.deactivate();var t=this.map.getLayers();t.forEach(function(t){t instanceof ol.layer.Vector&&t.get("layerName")===e&&t.getSource()&&t.getSource().clear&&t.getSource().clear()})}}},{key:"removePerimeterSreach",value:function(e,t){if(this.map&&e&&""!==e){var a=this.getLayerByName(e);a&&a.getSource()&&(a.getSource().clear(),this.circleSerachFeat.destroy(),this.circleSerachFeat=null)}}},{key:"removeFeatureByLayerNames",value:function(e){if(this.map&&e&&e instanceof Array){var t=this.map.getLayers();t.forEach(function(t){t instanceof ol.layer.Vector&&e.indexOf(t.get("layerName"))>=0&&t.getSource()&&t.getSource().clear&&t.getSource().clear()})}}},{key:"getLayerByFeatuer",value:function(e){if(this.map){var t=null;if(e instanceof ol.Feature){var a=this.map.getLayers();a.forEach(function(a){var r=a.getSource();if(r.getFeatures){var i=r.getFeatures();i.forEach(function(r){r==e&&(t=a)})}})}else console.info("传入的不是要素");return t}}},{key:"removeFeature",value:function(e){if(this.map)if(e instanceof ol.Feature){var t=this.getLayerByFeatuer(e);if(t){this.plotEdit&&this.plotEdit.activePlot&&this.plotEdit.activePlot===e&&this.plotEdit.deactivate();var a=t.getSource();if(a&&a.removeFeature){a.removeFeature(e),this.cursor_="pointer";var r=this.map.getTargetElement();r.firstElementChild.style.cursor="default",r.style.cursor="default"}}}else console.info("传入的不是要素")}},{key:"removeOverlayByLayerName",value:function(e){if(this.map)for(var t=this.map.getOverlays().getArray(),a=t.length,r=0;r<a;r++)t[r]&&t[r].get("layerName")===e&&(this.map.removeOverlay(t[r]),r--)}},{key:"removerLayerByLayerNames",value:function(e){var t=this;if(this.map){var a=this.map.getLayers();a.forEach(function(a){e.forEach(function(e){a.get("layerName")&&a.get("layerName")===e&&a.get("isImage")?t.map.removeLayer(a):a.get("layerName")&&a.get("layerName")===e&&!a.get("isImage")&&a.getSource().clear()})},this)}}},{key:"removeByLayerNames",value:function(e){var t=this;this.map&&e&&0!=e.length&&e.forEach(function(e){var a=t.getLayerByName(e);a&&a instanceof ol.layer.Vector?a.getSource().clear():a&&a instanceof ol.layer.Tile&&t.map.removeLayer(a)})}},{key:"removeTileLayerByLayerName",value:function(e){var t=this;if(this.map){var a=this.map.getLayers();a.forEach(function(a){a.get("isImage")&&a.get("layerName")&&a.get("layerName")===e&&t.map.removeLayer(a)},this)}}}]),HDMap}();exports.default=HDMap,module.exports=exports.default}])});