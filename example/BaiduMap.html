<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <title>openlayers扩展</title>
  <link rel="stylesheet" href="https://unpkg.com/openlayers@4.3.3/dist/ol.css">
  <style>
    html, body, #map {
      height: 100%;
      padding: 0;
      margin: 0;
    }

    .menu {
      position: absolute;
      width: 100%;
      height: 40px;
      line-height: 40px;
      text-align: center;
      z-index: 2;
    }

    .base-button {
      height: 30px;
      line-height: 30px;
      background: #1b9de8;
      color: #ffffff;
      border-radius: 6px;
      border: 1px solid #bfcbd9;
      padding: 0 10px;
      box-shadow: 0 4px 10px rgba(73, 127, 255, .42);
      transition: .3s;
    }

    .base-button:hover {
      cursor: pointer;
      border-color: #1b9de8;
      color: #ffffff;
    }
  </style>
</head>
<body>
<div id="map">
  <div class="menu">
    <button class="base-button" id="hdsx">关闭公司路况</button>
    <button class="base-button" id="baidu">关闭百度路况</button>
  </div>
</div>
<script src="https://unpkg.com/openlayers@4.3.3/dist/ol.js"></script>
<script src="https://unpkg.com/jquery@3.2.1/dist/jquery.js"></script>
<script type="text/javascript">
  /**
   * @classdesc
   * Layer source for the OpenStreetMap tile server.
   * @constructor
   * @extends {ol.source.XYZ}
   * @param {olx.source.OSMOptions=} optOptions Open Street Map options.
   * @api
   */
  ol.source.BAIDU = function (optOptions) {
    var options = optOptions || {}
    var attributions = ''
    if (options.attributions !== undefined) {
      attributions = options.attributions
    } else {
      attributions = [ol.source.BAIDU.ATTRIBUTION]
    }
    options.projection = options['projection'] ? options.projection : 'EPSG:3857'
    var crossOrigin = options.crossOrigin !== undefined ? options.crossOrigin : 'anonymous'
    var url = options.url !== undefined ? options.url : 'http://online{0-3}.map.bdimg.com/onlinelabel/?qt=tile&x={x}&y={y}&z={z}&styles=pl&udt=20170607&scaler=1&p=1'
    var tileUrlFunction = options.tileUrlFunction ? options.tileUrlFunction : undefined
    if (!tileUrlFunction) {
      tileUrlFunction = function (tileCoord) {
        var z = tileCoord[0]
        var x = tileCoord[1]
        var y = tileCoord[2]
        if (x < 0) {
          x = 'M' + (-x)
        }
        if (y < 0) {
          y = 'M' + (-y)
        }
        return url.replace('{0-3}', ol.source.BAIDU.getRandom(0, 3)).replace('{x}', (x).toString()).replace('{y}', y.toString()).replace('{z}', (z).toString())
      }
    }
    var levels = options['levels'] ? options['levels'] : 19
    var resolutions = []
    for (var z = 0; z < levels; z++) {
      resolutions[z] = Math.pow(2, levels - 1 - z)
    }
    var tileGrid = new ol.tilegrid.TileGrid({
      tileSize: options['tileSize'] ? options['tileSize'] : 256,
      origin: (options['origin'] ? options['origin'] : [0, 0]),
      extent: (options['extent'] ? options['extent'] : undefined),
      resolutions: resolutions,
      minZoom: ((options['minZoom'] && typeof options['minZoom'] === 'number') ? options['minZoom'] : 0)
    })
    ol.source.TileImage.call(this, {
      tileGrid: tileGrid,
      attributions: attributions,
      cacheSize: options.cacheSize,
      projection: options.projection,
      crossOrigin: crossOrigin,
      opaque: options.opaque !== undefined ? options.opaque : true,
      maxZoom: options.maxZoom !== undefined ? options.maxZoom : 19,
      reprojectionErrorThreshold: options.reprojectionErrorThreshold,
      tileUrlFunction: tileUrlFunction,
      url: url,
      wrapX: options.wrapX
    })
  }
  ol.inherits(ol.source.BAIDU, ol.source.TileImage)

  /**
   * 获取随机服务器
   * @param min
   * @param max
   * @returns {number}
   */
  ol.source.BAIDU.getRandom = function (min, max) {
    var r = Math.random() * (max - min)
    var re = Math.round(r + min)
    re = Math.max(Math.min(re, max), min)
    return re
  }

  /**
   * The attribution containing a link to the OpenStreetMap Copyright and License
   * page.
   * @const
   * @type {ol.Attribution}
   * @api
   */
  ol.source.BAIDU.ATTRIBUTION = new ol.Attribution({
    html: '&copy; ' +
    '<a href="http://map.baidu.com/">百度地图</a> ' +
    'contributors.'
  })
</script>
<script>
  var trafficServer = 'http://its.map.baidu.com:8002/traffic/TrafficTileService?time={time}&label=web2D&v=016&level={z}&x={x}&y={y}'
  var openHDSX = true, openBaidu = true;
  var baiduLayer = new ol.layer.Tile({
    source: new ol.source.BAIDU({
      projection: 'EPSG:3857',
      levels: 19,
      origin: [0, 0]
    })
  })
  var _map = new ol.Map({
    target: 'map',
    layers: [
      baiduLayer
    ],
    loadTilesWhileAnimating: true,
    view: new ol.View({
      projection: 'EPSG:3857',
//      center: [113.53450137499999, 34.44104525],
      center: [12649655.48971738, 4107475.901025431],
      zoom: 8
    })
  });
  _map.on('click', function (event) {
    console.log(event.coordinate)
  })

  /**
   * 通过layerName获取图层
   * @param layerName
   * @returns {*}
   */
  function getLayerByLayerName (layerName) {
    try {
      var targetLayer = null
      var layers = _map.getLayers().getArray()
      targetLayer = getLayerInternal(layers, 'layerName', layerName)
      return targetLayer
    } catch (e) {
      console.log(e)
    }
  }

  /**
   * 内部处理获取图层方法
   * @param layers
   * @param key
   * @param value
   * @returns {*}
   */
  function getLayerInternal (layers, key, value) {
    var _target = null
    if (layers.length > 0) {
      layers.every(function (layer) {
        if (layer instanceof ol.layer.Group) {
          let layers = layer.getLayers().getArray()
          _target = getLayerInternal(layers, key, value)
          if (_target) {
            return false
          } else {
            return true
          }
        } else if (layer.get(key) === value) {
          _target = layer
          return false
        } else {
          return true
        }
      })
    }
    return _target
  }

  /**
   * 移除图层
   * @param layerName
   */
  function removeLayerByLayerName (layerName) {
    var layer = getLayerByLayerName(layerName)
    if (layer) {
      _map.removeLayer(layer)
    }
  }

  function createTileWMSLayer (params) {
    try {
      var layer = new ol.layer.Tile({
        layerName: 'HDSX',
        source: new ol.source.TileWMS({
          url: params['layerUrl'],
          params: {
            LAYERS: params['layers'], // require
            STYLES: params['style'] ? params['style'] : '',
            VERSION: params['version'] ? params['version'] : '1.3.0',
            WIDTH: params['width'] ? params['width'] : 256,
            HEIGHT: params['height'] ? params['height'] : 256,
            SRS: (params['srs'] ? params['srs'] : 'EPSG:3857'),
            CRS: (params['srs'] ? params['srs'] : 'EPSG:3857'),
            REQUEST: 'GetMap',
            TRANSPARENT: true,
            TILED: true,
            SERVICE: 'WMS',
            FORMAT: 'image/png',
            VIEWPARAMS: ''
          },
          wrapX: false
        })
      })
      return layer
    } catch (e) {
      console.log(e)
    }
  }

  function addBaiDuRoadState () {
    removeLayerByLayerName('BaiDu')
    var baiDuRoadState = new ol.layer.Tile({
      layerName: 'BaiDu',
      source: new ol.source.BAIDU({
        url: trafficServer.replace('{time}', (new Date().getTime()) + ''),
        projection: 'EPSG:3857',
        levels: 19,
        origin: [0, 0]
      })
    })
    _map.addLayer(baiDuRoadState)
  }

  function creatWMS () {
    removeLayerByLayerName('HDSX')
    var wms = createTileWMSLayer({
      layerUrl: 'http://192.168.0.226:8089/geoserver/hnway/wms',
      layers: 'hnway:roadSituation',
      styles: '',
      projection: 'EPSG:4326',
      tiled: true
    })
    _map.addLayer(wms)
  }

  $('#hdsx').on('click', function () {
    if (openHDSX) {
      $('#hdsx').text('开闭公司路况')
      removeLayerByLayerName('HDSX')
      openHDSX = false
    } else {
      $('#hdsx').text('关启公司路况')
      openHDSX = true
      creatWMS()
    }
  })

  $('#baidu').on('click', function () {
    if (openBaidu) {
      $('#baidu').text('开闭百度路况')
      removeLayerByLayerName('BaiDu')
      openBaidu = false
    } else {
      $('#baidu').text('关启百度路况')
      openBaidu = true
      addBaiDuRoadState()
    }
  })

  function addLayers () {
    if (openBaidu) {
      addBaiDuRoadState()
    }
    if (openHDSX) {
      creatWMS()
    }
    window.setInterval(function () {
      if (openBaidu) {
        addBaiDuRoadState()
      }
      if (openHDSX) {
        creatWMS()
      }
    }, 60 * 1000 * 2)
  }

  addLayers()
</script>
</body>
</html>
