<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <title>openlayers扩展</title>
  <link rel="stylesheet" href="https://unpkg.com/openlayers@4.3.3/dist/ol.css">
  <style>
    html, body, #map {
      height: 100%;
      padding: 0;
      margin: 0;
    }
  </style>
</head>
<body>
<div id="map"></div>
<script src="https://unpkg.com/openlayers@4.3.3/dist/ol.js"></script>
<script src="https://unpkg.com/jquery@3.2.1/dist/jquery.js"></script>
<script src="./baiduProj.min.js"></script>
<script>

  var extent = [72.004, 0.8293, 137.8347, 55.8271];

  var baiduMercator = new ol.proj.Projection({
    code: 'baidu',
    extent: ol.extent.applyTransform(extent, projzh.ll2bmerc),
    units: 'm'
  });

  ol.proj.addProjection(baiduMercator);
  ol.proj.addCoordinateTransforms('EPSG:4326', baiduMercator, projzh.ll2bmerc, projzh.bmerc2ll);
  ol.proj.addCoordinateTransforms('EPSG:3857', baiduMercator, projzh.smerc2bmerc, projzh.bmerc2smerc);

  var bmercResolutions = new Array(19);
  for (var i = 0; i < 19; ++i) {
    bmercResolutions[i] = Math.pow(2, 18 - i);
  }

  var urls = [0, 1, 2, 3, 4].map(function(sub) {
    return 'http://online' + sub + '.map.bdimg.com/onlinelabel/?qt=tile&x={x}&y={y}&z={z}&styles=pl&udt=20170607&scaler=1&p=1';
  });

  var baidu = new ol.layer.Tile({
    source: new ol.source.XYZ({
      projection: 'baidu',
      maxZoom: 18,
      tileUrlFunction: function(tileCoord) {
        var x = tileCoord[1];
        var y = tileCoord[2];
        var z = tileCoord[0];
        var hash = (x << z) + y;
        var index = hash % urls.length;
        index = index < 0 ? index + urls.length : index;
        return urls[index].replace('{x}', x).replace('{y}', y).replace('{z}', z);
      },
      tileGrid: new ol.tilegrid.TileGrid({
        resolutions: bmercResolutions,
        origin: [0, 0],
        extent: ol.extent.applyTransform(extent, projzh.ll2bmerc),
        tileSize: [256, 256]
      })
    })
  });

  var _map = new ol.Map({
    target: 'map',
    layers: [
      baidu
    ],
    loadTilesWhileAnimating: true,
    view: new ol.View({
      projection: 'baidu',
//      center: [113.53450137499999, 34.44104525],
      center: [12649655.48971738, 4107475.901025431],
      zoom: 8
    })
  });
  _map.on('click', function (event) {
    console.log(event.coordinate)
  })

  function createTileWMSLayer (params) {
    try {
      var layer = new ol.layer.Tile({
        source: new ol.source.TileWMS({
          url: params['layerUrl'],
          params: {
            LAYERS: params['layers'], // require
            STYLES: params['style'] ? params['style'] : '',
            VERSION: params['version'] ? params['version'] : '1.3.0',
            WIDTH: params['width'] ? params['width'] : 256,
            HEIGHT: params['height'] ? params['height'] : 256,
            SRS: (params['srs'] ? params['srs'] : 'EPSG:3857'),
            CRS: (params['srs'] ? params['srs'] : 'EPSG:3857'),
            REQUEST: 'GetMap',
            TRANSPARENT: true,
            TILED: true,
            SERVICE: 'WMS',
            FORMAT: 'image/png',
            VIEWPARAMS: ''
          },
          wrapX: false
        })
      })
      return layer
    } catch (e) {
      console.log(e)
    }
  }

  function creatWMS () {
    var wms = createTileWMSLayer({
      layerUrl: 'http://192.168.0.226:8089/geoserver/hnway/wms',
      layers: 'hnway:traffic_network_hn_baidu',
      styles: '',
      projection: 'EPSG:3857',
      tiled: true
    })
    _map.addLayer(wms)
  }
  creatWMS()
</script>
</body>
</html>
